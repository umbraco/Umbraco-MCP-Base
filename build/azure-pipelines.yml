trigger:
  branches:
    include:
    - main
    - feature/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: nodeVersion
    value: '22.x'
  - name: sdkPackagePath
    value: 'packages/mcp-server-sdk'

stages:
- stage: BuildAndTest
  displayName: 'Build & Test'
  jobs:
  - job: Build
    displayName: 'Build SDK Package'
    steps:
    - task: NodeTool@0
      displayName: 'Use Node.js $(nodeVersion)'
      inputs:
        versionSpec: '$(nodeVersion)'

    - task: Cache@2
      displayName: 'Cache node_modules'
      inputs:
        key: 'npm | "$(Agent.OS)" | package-lock.json'
        restoreKeys: |
          npm | "$(Agent.OS)"
          npm
        path: 'node_modules'

    - script: npm ci
      displayName: 'Install dependencies'

    - script: npm run build
      displayName: 'Build TypeScript'

    - script: npm run test
      displayName: 'Run tests'

    - task: PublishTestResults@2
      displayName: 'Publish test results'
      condition: succeededOrFailed()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/junit.xml'
        failTaskOnFailedTests: true
        failTaskOnMissingResultsFile: false

    - script: npm pack --pack-destination $(Build.ArtifactStagingDirectory)
      displayName: 'Create NPM package'
      workingDirectory: $(sdkPackagePath)

    - task: PublishPipelineArtifact@1
      displayName: 'Publish NPM package to artifacts'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)'
        artifact: 'npm-package'

- stage: Deploy_Npm
  displayName: 'NPM release'
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  dependsOn:
    - BuildAndTest
  jobs:
    - job: Publish
      displayName: Push to NPM
      steps:
        - checkout: self
        - task: NodeTool@0
          displayName: 'Use Node.js $(nodeVersion)'
          inputs:
            versionSpec: '$(nodeVersion)'
        - download: current
          artifact: 'npm-package'
        - bash: echo "@umbraco-cms:registry=https://registry.npmjs.org" >> .npmrc
          workingDirectory: $(Pipeline.Workspace)/npm-package
          displayName: Add scoped registry to .npmrc
        - task: npmAuthenticate@0
          displayName: Authenticate with npm
          inputs:
            workingFile: $(Pipeline.Workspace)/npm-package/.npmrc
            customEndpoint: "NPM - Umbraco Backoffice"
        - script: |
            # Setup temp npm project to load in defaults from the local .npmrc
            npm init -y

            # Find the first .tgz file in the current directory
            files=( ./*.tgz )

            # Extract version from package.json in the tarball
            tar -tf "${files[0]}" | grep package/package.json | head -1 | xargs tar -xf "${files[0]}" --strip-components=1
            version=$(node -p "require('./package.json').version")

            # Determine tag based on version
            if [[ "${version}" == *"alpha"* ]]; then
              tag="alpha"
            elif [[ "${version}" == *"beta"* ]]; then
              tag="beta"
            elif [[ "${version}" == *"rc"* ]]; then
              tag="rc"
            else
              tag="latest"
            fi

            echo "Publishing version ${version} with tag ${tag}"
            npm publish "${files[0]}" --tag $tag --access public
          displayName: Push to npm with dynamic tagging
          workingDirectory: $(Pipeline.Workspace)/npm-package
