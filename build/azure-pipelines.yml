trigger:
  branches:
    include:
    - main
    - feature/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: nodeVersion
    value: '22.x'
  - name: sdkPackagePath
    value: 'packages/mcp-server-sdk'
  - name: cliPackagePath
    value: 'packages/create-mcp-server'

stages:
- stage: BuildAndTest
  displayName: 'Build & Test'
  jobs:
  - job: BuildSDK
    displayName: 'Build SDK Package'
    steps:
    - task: NodeTool@0
      displayName: 'Use Node.js $(nodeVersion)'
      inputs:
        versionSpec: '$(nodeVersion)'

    - task: Cache@2
      displayName: 'Cache node_modules'
      inputs:
        key: 'npm | "$(Agent.OS)" | package-lock.json'
        restoreKeys: |
          npm | "$(Agent.OS)"
          npm
        path: 'node_modules'

    - script: npm ci
      displayName: 'Install dependencies'

    - script: npm run build
      displayName: 'Build TypeScript'

    - script: npm run test
      displayName: 'Run tests'

    - task: PublishTestResults@2
      displayName: 'Publish test results'
      condition: succeededOrFailed()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/junit.xml'
        failTaskOnFailedTests: true
        failTaskOnMissingResultsFile: false

    - script: npm pack --pack-destination $(Build.ArtifactStagingDirectory)
      displayName: 'Create NPM package'
      workingDirectory: $(sdkPackagePath)

    - task: PublishPipelineArtifact@1
      displayName: 'Publish SDK package to artifacts'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)'
        artifact: 'sdk-package'

  - job: BuildCLI
    displayName: 'Build CLI Package'
    steps:
    - task: NodeTool@0
      displayName: 'Use Node.js $(nodeVersion)'
      inputs:
        versionSpec: '$(nodeVersion)'

    - task: Cache@2
      displayName: 'Cache node_modules'
      inputs:
        key: 'npm | "$(Agent.OS)" | package-lock.json'
        restoreKeys: |
          npm | "$(Agent.OS)"
          npm
        path: 'node_modules'

    - script: npm ci
      displayName: 'Install dependencies'

    - script: npm run build
      displayName: 'Build SDK (workspace dependency)'

    - script: npm run build -w $(cliPackagePath)
      displayName: 'Build CLI'

    - script: npm test -w $(cliPackagePath)
      displayName: 'Run CLI tests'

    - script: npm pack --pack-destination $(Build.ArtifactStagingDirectory)
      displayName: 'Create NPM package'
      workingDirectory: $(cliPackagePath)

    - task: PublishPipelineArtifact@1
      displayName: 'Publish CLI package to artifacts'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)'
        artifact: 'cli-package'

- stage: Deploy_Npm
  displayName: 'NPM release'
  condition: succeeded()  # TODO: restore main-only gate: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  dependsOn:
    - BuildAndTest
  jobs:
    - job: PublishSDK
      displayName: Publish SDK to NPM
      steps:
        - checkout: self
        - task: NodeTool@0
          displayName: 'Use Node.js $(nodeVersion)'
          inputs:
            versionSpec: '$(nodeVersion)'
        - download: current
          artifact: 'sdk-package'
        - bash: echo "@umbraco-cms:registry=https://registry.npmjs.org" >> .npmrc
          workingDirectory: $(Pipeline.Workspace)/sdk-package
          displayName: Add scoped registry to .npmrc
        - task: npmAuthenticate@0
          displayName: Authenticate with npm
          inputs:
            workingFile: $(Pipeline.Workspace)/sdk-package/.npmrc
            customEndpoint: "NPM - Umbraco Backoffice"
        - script: |
            npm init -y
            tgz=(*.tgz)
            tar -xf "${tgz[0]}" --strip-components=1 package/package.json
            name=$(node -p "require('./package.json').name")
            version=$(node -p "require('./package.json').version")

            if npm view "${name}@${version}" version 2>/dev/null; then
              echo "##[warning]Skipping ${name}@${version} — already published"
              exit 0
            fi

            if [[ "$version" == *"alpha"* ]]; then tag="alpha"
            elif [[ "$version" == *"beta"* ]]; then tag="beta"
            elif [[ "$version" == *"rc"* ]]; then tag="rc"
            else tag="latest"
            fi

            echo "Publishing ${name}@${version} with tag ${tag}"
            npm publish "${tgz[0]}" --tag "$tag" --access public --dry-run
          displayName: Publish SDK to npm (dry-run)
          workingDirectory: $(Pipeline.Workspace)/sdk-package

    - job: PublishCLI
      displayName: Publish CLI to NPM
      steps:
        - checkout: self
        - task: NodeTool@0
          displayName: 'Use Node.js $(nodeVersion)'
          inputs:
            versionSpec: '$(nodeVersion)'
        - download: current
          artifact: 'cli-package'
        - bash: echo "@umbraco-cms:registry=https://registry.npmjs.org" >> .npmrc
          workingDirectory: $(Pipeline.Workspace)/cli-package
          displayName: Add scoped registry to .npmrc
        - task: npmAuthenticate@0
          displayName: Authenticate with npm
          inputs:
            workingFile: $(Pipeline.Workspace)/cli-package/.npmrc
            customEndpoint: "NPM - Umbraco Backoffice"
        - script: |
            npm init -y
            tgz=(*.tgz)
            tar -xf "${tgz[0]}" --strip-components=1 package/package.json
            name=$(node -p "require('./package.json').name")
            version=$(node -p "require('./package.json').version")

            if npm view "${name}@${version}" version 2>/dev/null; then
              echo "##[warning]Skipping ${name}@${version} — already published"
              exit 0
            fi

            if [[ "$version" == *"alpha"* ]]; then tag="alpha"
            elif [[ "$version" == *"beta"* ]]; then tag="beta"
            elif [[ "$version" == *"rc"* ]]; then tag="rc"
            else tag="latest"
            fi

            echo "Publishing ${name}@${version} with tag ${tag}"
            npm publish "${tgz[0]}" --tag "$tag" --access public --dry-run
          displayName: Publish CLI to npm (dry-run)
          workingDirectory: $(Pipeline.Workspace)/cli-package
